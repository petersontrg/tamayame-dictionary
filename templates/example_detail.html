{% extends "layout.html" %}
{% block content %}

{% set slotted = example.slotted_allomorphs or slotted_allomorphs or {} %}
{% set prmp = prmp_allomorphs or example_prmp_allomorphs or example.prmp_allomorphs or [] %}
{% set ta   = ta_allomorphs   or example_ta_allomorphs   or example.ta_allomorphs   or [] %}
{% set allomorphs = allomorphs or example_allomorphs or example.allomorphs or (prmp + ta) %}

{# ---- UI labels for slots (human-friendly) ---- #}
{% set slot_labels = {
  '100': 'Pronominal Prefix (PRMP)',
  '200': 'Future',
  '300': 'Voice/Derivation',
  '400': 'Aspect',
  '500': 'Agreement',
  '600': 'Conditional/Modal',
  'B':   'Benefactive',
  'TA':  'Thematic Number Agreement',
  'ROOT': 'Root'
} %}


{# ---- tiny helpers ---- #}
{% macro slot_badges(slot, a) -%}
  {# subletter & source for 400/500/600 #}
  {% if slot in ['400','500','600'] and a.slot_code %}
    <span class="ml-2 px-2 py-0.5 rounded bg-gray-100 text-gray-700 text-xs align-middle">{{ a.slot_code }}</span>
    {% if a.source %}
      <span class="ml-1 text-xs text-gray-500 align-middle">[{{ a.source }}]</span>
    {% endif %}
  {% endif %}
  {# TA voice class #}
  {% if slot == 'TA' and a.voice_class %}
    <span class="ml-2 text-xs text-gray-600 align-middle">(VC: {{ a.voice_class }})</span>
  {% endif %}
  {# Davis id: link to partial-paradigm page when it looks like 1a/2b/... #}
  {% if a.davis_id %}
    {% if a.davis_id|lower in ['1a','1b','2a','2b','3a','3b'] %}
      <a href="{{ url_for('partial_paradigm_detail', label=a.davis_id, entry_id=example.entry_id if example.entry_id else None) }}"
         class="ml-2 text-xs text-indigo-600 hover:underline align-middle">({{ a.davis_id }})</a>a
    {% else %}
      <span class="ml-2 text-xs text-gray-500 align-middle">({{ a.davis_id }})</span>
    {% endif %}
  {% endif %}
{%- endmacro %}

<h2 class="text-2xl font-bold mb-2">{{ example.tamayame_text }}</h2>
<p class="text-gray-800 mb-4">{{ example.translation_en }}</p>

<hr class="my-4">

{# --- Stem morphology (compact, two lines) --- #}
{% if example.morphemes %}
  {% set ordered = example.morphemes|sort(attribute='ordering') %}

  {# segments line #}
  <div class="mt-6">
    <h3 class="text-lg font-semibold">Stem morphology (using URs)</h3>
    <div>
      {{ ordered | map(attribute='segment') | select | list | join('-') }}
    </div>

    {# gloss line (falls back to '—' if a gloss is empty) #}
    <div>
      {{
        ordered
        | map(attribute='gloss')
        | map('default', '—')
        | select
        | list
        | join('-')
      }}
    </div>
  </div>
{% endif %}

<hr class="my-4">

{# -------- Template link -------- #}
{% if example.template %}
  <div class="mt-2 mb-4">
    <h3 class="text-lg font-semibold">Template</h3>
    <p class="text-gray-800">
      <a href="{{ url_for('template_detail', template_id=example.template.template_id) }}"
         class="text-blue-600 hover:underline">
        {{ example.template.name }}
      </a>
    </p>
  </div>
{% endif %}

{# -------- Slotted view with clearer labels + badges -------- #}
{% if slotted|length > 0 %}
  <hr class="my-4">
  <h3 class="text-lg font-semibold mb-2">Morphemes</h3>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
    {% for slot, items in slotted.items() %}
      <div class="p-3 rounded border bg-white">
        <h4 class="font-medium text-gray-700 mb-1">
          {{ slot_labels.get(slot, 'Slot ' ~ slot) }}
          <span class="text-xs text-gray-500">({{ slot }})</span>
        </h4>
        <ul class="text-sm text-gray-800 ml-4 list-disc space-y-1">
          {% for a in items %}
            <li>
              <span class="font-mono">{{ a.form }}</span>
              {% if a.ur_gloss %} — <span>{{ a.ur_gloss }}</span>{% endif %}
              {{ slot_badges(slot, a) }}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-gray-600">No allomorphs linked for this example.</p>
{% endif %}



<hr class="my-4">

<div class="flex items-center gap-4">
  <a href="{{ url_for('edit_realization', example_id=example.example_id) }}"
     class="text-blue-600 hover:underline">Edit SR/UR/pronunciation</a>
  {# Uncomment when ready:
  <a href="{{ url_for('edit_example', example_id=example.example_id) }}"
     class="text-blue-600 hover:underline">Edit all fields</a>
  #}
</div>

{% if example.comment %}
  <hr class="my-4">
  <p><strong>Morphophonology:</strong> {{ example.comment }}</p>
{% endif %}

{% endblock %}
