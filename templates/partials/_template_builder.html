<!-- templates/partials/_template_builder.html -->
<div>
  <h3 class="text-lg font-semibold mb-2">Stem Builder</h3>
  <p class="text-sm text-gray-600 mb-1">
    Drag blocks below to compose a valid verb stem template. Start with the TA (if there is one), then drop the other
    blocks in the order they occur in the stem. Then select the allomorph from the drop-down menus, if applicable.
  </p>

  <!-- Slot palette / pool -->
  <div id="slot-pool" class="flex flex-wrap gap-2 mb-3">
    {% for s in ['TA', '100', '200', '300', '400', '500', '600', 'ROOT', 'B'] %}
      <div class="slot cursor-move px-2 py-1 border rounded bg-white shadow text-sm" data-slot="{{ s }}">
        {{ s }}
      </div>
    {% endfor %}
  </div>

  <p class="text-sm text-gray-600">Drop your slot sequence here:</p>
  <div id="slot-target"
       class="min-h-[56px] flex flex-wrap gap-2 border border-dashed rounded p-2 bg-gray-50 mb-2">
    {# The builder script will append cloned slot blocks here. #}
  </div>

  <div id="template-feedback" class="text-sm text-indigo-700 mb-3 italic"></div>

  <button type="button"
          onclick="validateTemplate()"
          class="text-sm text-indigo-600 hover:underline">
    Validate Template
  </button>

  <!-- This hidden field must match the one your form handler reads -->
  <input type="hidden" name="template_id" id="template_id">
</div>

<!-- Hidden HTML templates; the builder script clones these by slot type. -->
<!-- TA -->
<template id="tpl-slot-TA">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="TA">
    <span class="font-semibold w-12">TA</span>
    <select name="ta_allomorph_ids[]" data-slot-code="TA" class="border px-2 py-1 rounded w-56">
      <option value="">— choose —</option>
      {% for t in (TA_ALLOMORPHS | default([])) %}
        <option value="{{ t.id }}" data-number="{{ t.number|e }}" data-voice="{{ t.voice_class|default('')|e }}">
          {{ t.label }}
        </option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="TA">
  </div>
</template>

<!-- 100 (PRMP) -->
<template id="tpl-slot-100">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="100">
    <span class="font-semibold w-12">100</span>
    <select name="allomorph_ids[]" data-slot-code="100" class="border px-2 py-1 rounded w-64" disabled>
      <option value="">— choose —</option>
      {# Options are fetched after TA and/or 300 change. #}
    </select>
    <input type="hidden" name="slots[]" value="100">
  </div>
</template>

<!-- 200 -->
<template id="tpl-slot-200">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="200">
    <span class="font-semibold w-12">200</span>
    <select name="allomorph_ids[]" data-slot-code="200" class="border px-2 py-1 rounded w-64">
      <option value="">— choose —</option>
      {% for a in ((SLOT_ALLOMORPHS | default({})).get('200', [])) %}
        <option value="{{ a.id }}">{{ a.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="200">
  </div>
</template>

<!-- 300 (Voice) -->
<template id="tpl-slot-300">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="300">
    <span class="font-semibold w-12">300</span>
    <select name="allomorph_ids[]" data-slot-code="300" class="border px-2 py-1 rounded w-72">
      <option value="">— choose —</option>
      {% for a in ((SLOT_ALLOMORPHS | default({})).get('300', [])) %}
        <option value="{{ a.id }}">{{ a.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="300">
  </div>
</template>

<!-- 400 -->
<template id="tpl-slot-400">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="400">
    <span class="font-semibold w-12">400</span>
    <select name="allomorph_ids[]" data-slot-code="400" class="slot-400 border px-2 py-1 rounded w-64">
      <option value="">— choose —</option>
      {% for a in ((SLOT_ALLOMORPHS | default({})).get('400', [])) %}
        <option value="{{ a.id }}">{{ a.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="400">
  </div>
</template>

<!-- 500 -->
<template id="tpl-slot-500">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="500">
    <span class="font-semibold w-12">500</span>
    <select name="allomorph_ids[]" data-slot-code="500" class="slot-500 border px-2 py-1 rounded w-64">
      <option value="">— choose —</option>
      {% for a in ((SLOT_ALLOMORPHS | default({})).get('500', [])) %}
        <option value="{{ a.id }}">{{ a.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="500">
  </div>
</template>

<!-- 600 -->
<template id="tpl-slot-600">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="600">
    <span class="font-semibold w-12">600</span>
    <select name="allomorph_ids[]" data-slot-code="600" class="border px-2 py-1 rounded w-64">
      <option value="">— choose —</option>
      {% for a in ((SLOT_ALLOMORPHS | default({})).get('600', [])) %}
        <option value="{{ a.id }}">{{ a.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="600">
  </div>
</template>

<!-- ROOT -->
<template id="tpl-slot-ROOT">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="ROOT">
    <span class="font-semibold w-12">ROOT</span>
    <select name="morpheme_ids[]" data-slot-code="ROOT" class="border px-2 py-1 rounded w-64">
      <option value="">— choose —</option>
      {% for m in (MORPHEMES | default([])) %}
        <option value="{{ m.id }}">{{ m.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="ROOT">
  </div>
</template>

<!-- B -->
<template id="tpl-slot-B">
  <div class="slot px-2 py-2 border rounded bg-white shadow text-sm flex items-center gap-2" data-slot="B">
    <span class="font-semibold w-12">B</span>
    {% set b_opts = (SLOT_ALLOMORPHS | default({})).get('B', []) %}
    <select name="allomorph_ids[]" data-slot-code="B" class="border px-2 py-1 rounded w-64" {% if not b_opts %}disabled{% endif %}>
      <option value="">— choose —</option>
      {% for a in b_opts %}
        <option value="{{ a.id }}">{{ a.label }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="slots[]" value="B">
  </div>
</template>